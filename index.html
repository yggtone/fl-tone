<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<!-- "audio/sine440.wav" -->

<p>Audio Test</p>

<script src="js/buffer-loader.js"></script>

<script>

window.onload = init;
var context;
var bufferLoader;

var newestSource;

var pitch = 1.5;

function init() {
  // Fix up prefixing
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  context = new AudioContext();

  bufferLoader = new BufferLoader(
    context,
    [
      'audio/saw.wav',
      'audio/sine440.wav',
    ],
    finishedLoading
    );

  bufferLoader.load();
}

//new sounds must create a source each time, seems inefficient, but this
//is the requirement at the time of this writing http://updates.html5rocks.com/2012/01/Web-Audio-FAQ
function playSound(buffer, time) {
  var source = context.createBufferSource();
  source.buffer = buffer;
  source.connect(context.destination);
  source.start(time);
  source.loop = true;

  newestSource = source;
}


function createSource(buffer) {
  var source = context.createBufferSource();
  // Create a gain node.
  var gainNode = context.createGain();
  source.buffer = buffer;
  // Turn on looping.
  source.loop = true;
  // Connect source to gain.
  source.connect(gainNode);
  // Connect gain to destination.
  gainNode.connect(context.destination);

  return {
    source: source,
    gainNode: gainNode
  };
}

var sourceA, sourceB;

function finishedLoading(bufferList) {
  // Create two sources and play them both together.
  //var source1 = context.createBufferSource();
  //var source2 = context.createBufferSource();
  //source1.buffer = bufferList[0];
  //source2.buffer = bufferList[1];
  //source1.connect(context.destination);
  //source2.connect(context.destination);
  //source1.start(0);
  //source2.start(0);

  //prebuffer
  sourceA = createSource(bufferList[0]);
  sourceA.source.start(0);
  sourceA.gainNode.gain.value = 0.1;
  sourceA.source.playbackRate.value = 0.3;
  
  sourceB = createSource(bufferList[1]);
  sourceB.source.start(0);
  sourceB.gainNode.gain.value = 0.1;
  sourceB.source.playbackRate.value = 1.0;
}

function setPitch(source,rate) 
{
  
  source.playbackRate.value = rate;

}

</script>

<input type="button" value="Play" onclick="playSound(sourceA.source.buffer,0);"></input>
<input type="button" value="Stop" onclick="newestSource.stop(0);"></input>
<input type="button" value="Pitch" onclick="pitch += 0.01; newestSource.playbackRate.value = pitch;"></input>
<input type="range" oninput="setPitch(sourceA.source,value);" value="1.0" step="0.0001" max="3.0" min="0.3"></input>
<BR>
<input type="button" value="Play" onclick="playSound(sourceA.source.buffer,0);"></input>
<input type="button" value="Stop" onclick="newestSource.stop(0);"></input>
<input type="button" value="Pitch" onclick="pitch += 0.01; newestSource.playbackRate.value = pitch;"></input>
<input type="range" oninput="setPitch(sourceB.source,value);" value="1.0" step="0.001" max="3.0" min="0.3"></input>


</html>
